{extend name="templates/public/base.html" /}
{block name="cascade"}
<!--联动选择框 -->
<!-- <div class="container-fluid"> -->
    <form class="layui-form layui-form-pane" action="">
    <div class="layui-row">
        <div class="layui-input-inline layui-col-xs4">
        <select name="type1" id="type1" lay-filter="type1">
            <option value="">项目性质</option>
            {volist name="firstCates" id="firstCate"}
            <option value="{$firstCate.id}">{$firstCate.name}</option>
            {/volist}
        </select>
        </div>
        <div class="layui-input-inline layui-col-xs4">
        <select name="type2" id="type2" lay-filter="typeRole">
        <!-- js -->
        </select>
        </div>
        <div class="layui-input-inline layui-col-xs4">
        <select name="role" id="role" lay-filter="typeRole">
            <option value="">需求角色</option>
            {volist name="roles" id="role"}
            <option value="{$role.id}">{$role.name}</option>
            {/volist}
        </select>
        </div>
    </div>
    </form>
    <br />
<!-- </div> -->
{/block}
{block name="main"}
<div class="layui-container-fluid" id="list">
    <div class="layui-row layui-col-space12" id="main" style="margin-left:10px;margin-right:10px;margin-bottom:10px;">
        {volist name="projList" id="proj"}
        <div class="layui-col-md4 layui-col-xs12">
          <div style="height:200px;padding:10px;background-image:url({$proj.image});background-size:contain;
          background-repeat:round;background-color: #3a3744;opacity: 0.86;color: #eee;"> 
            <p><b>{$proj.cate_name} : {$proj.name}</b></p>
            <p>{$proj.intro}</p>
            <p><a style="color:#fff;" href={:url("index/index/view","id=$proj[id]")}>查看详情 »»»</a>&emsp;&emsp;</p>
          </div>
        </div>
        {/volist}
    </div>
    <div class="layui-container" align="center" id="paginate">{$projList->render()}</div>
</div>
{/block}
{block name="free_js"}
{__block__}
<script>
  layui.use(['form','laypage'],function(){
    var form = layui.form;
    var laypage = layui.laypage;
    laypage.render({
        elem: 'paginate',
        count: 50,
        limit: 9
    });
    form.on('select(type1)',function(data){
        if(data.value){
        $.get(
            "{:url('index/index/getChildType')}"+"?pid="+data.value,
            function(data){
                var optionStr = "";
                $.each(data,function(i,item){
                optionStr += "<option value='"+item.id+"'>"+item.name+"</option>";
                });
                $("#type2").html('<option value="">二级分类</option>'+optionStr);
                form.render('select');
            }
        );
        }
        var cid1 = $("#type1").val();
        var cid2 = $("#type2").val();
        if(!cid2){cid = cid1;}else{cid = cid2;}
        var rid = $("#role").val();
        if(!cid)cid=0;
        if(!rid)rid=0;
        $.get(
            "{:url('index/index/getFilterResult')}"+"?cid="+cid+"&rid="+rid,
            function(data){
                console.log(data.length); //!!!!!!解决分页问题就靠你了！
                var num = data.length;
                var mainStr = "";
                $.each(data,function(i,item){
                    mainStr += `
                    <div class="layui-col-md4 layui-col-xs12">
                        <div style="height:200px;padding:10px;background-image:url(${item.image});background-size:contain;
                        background-repeat:round;background-color: #3a3744;opacity: 0.86;color: #eee;"> 
                            <p><b>${item.cate_name} : ${item.name}</b></p>
                            <p>${item.intro}</p>
                            <p><a class="layui-btn" href={:url("index/index/view")}?id=${item.id}>查看详情 »</a>&emsp;&emsp;</p>
                        </div>
                    </div>
                    `;
                });
                $("#main").html(mainStr);
                form.render();
            }  
        );
    }); //select(type1)

    form.on('select(typeRole)',function(data){
        var cid1 = $("#type1").val();
        var cid2 = $("#type2").val();
        if(!cid2){cid = cid1;}else{cid = cid2;}
        var rid = $("#role").val();
        if(!cid)cid=0;
        if(!rid)rid=0;
        $.get(
            "{:url('index/index/getFilterResult')}"+"?cid="+cid+"&rid="+rid,
            function(data,status){
                var mainStr = "";
                $.each(data,function(i,item){
                    mainStr += `
                    <div class="layui-col-md4 layui-col-xs12">
                        <div style="height:200px;padding:10px;background-image:url(${item.image});background-size:contain;
                        background-repeat:round;background-color: #3a3744;opacity: 0.86;color: #eee;"> 
                            <p><b>${item.cate_name} : ${item.name}</b></p>
                            <p>${item.intro}</p>
                            <p><a class="layui-btn" href={:url("index/index/view")}?id=${item.id}>查看详情 »</a>&emsp;&emsp;</p>
                        </div>
                    </div>
                    `;
                });
                $("#main").html(mainStr);
                form.render();
            }
        );
    });

  });
</script>
{/block}